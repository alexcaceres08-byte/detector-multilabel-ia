<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detector Multilabel IA</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f4f7f6; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .card { background: white; padding: 2rem; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 400px; text-align: center; border: 1px solid #eee; }
        h1 { color: #2c3e50; margin: 0; font-size: 1.8rem; }
        h1 span { color: #3498db; }
        
        .upload-btn { background-color: #3498db; color: white; padding: 12px 25px; border-radius: 50px; cursor: pointer; display: inline-block; font-weight: 600; margin-top: 20px; transition: 0.2s; box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3); }
        .upload-btn:hover { background-color: #2980b9; transform: translateY(-2px); }
        input[type="file"] { display: none; }
        
        #preview { width: 100%; height: 220px; object-fit: cover; border-radius: 12px; margin-top: 20px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .loader { display: none; margin-top: 15px; color: #7f8c8d; font-size: 0.9rem; font-weight: 500; }
        
        /* Resultados */
        #resultados-container { margin-top: 20px; text-align: left; display: none; }
        .result-item { margin-bottom: 12px; }
        .label-row { display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: 700; color: #555; margin-bottom: 4px; }
        .progress-bg { background-color: #ecf0f1; border-radius: 6px; height: 10px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.8s ease-out; border-radius: 6px; }
        
        .high { background-color: #2ecc71; } 
        .mid { background-color: #f1c40f; }  
        .low { background-color: #e74c3c; } 

        /* VEREDICTO */
        #veredicto { margin-top: 20px; padding: 15px; border-radius: 10px; font-weight: 800; display: none; text-transform: uppercase; letter-spacing: 0.5px; font-size: 1rem; line-height: 1.4; }
        .veredicto-exito { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .veredicto-duda { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* Re-entrenar */
        #teach-section { display: none; margin-top: 30px; border-top: 2px dashed #eee; padding-top: 20px; animation: fadeIn 0.5s; }
        .checkbox-group { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .checkbox-group label { cursor: pointer; font-size: 0.9rem; color: #555; }
        .teach-btn { background-color: #9b59b6; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; transition: 0.2s; }
        .teach-btn:hover { background-color: #8e44ad; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="card">
    <h1>üß† Detector <span>IA</span></h1>
    <label class="upload-btn">üìÇ Subir Imagen
        <input type="file" id="fileInput" accept="image/*" onchange="procesarImagen()">
    </label>
    
    <img id="preview" src="">
    <div id="loader" class="loader">Analizando p√≠xeles... üì°</div>
    
    <div id="veredicto"></div>

    <div id="resultados-container"></div>

    <div id="teach-section">
        <p style="font-size:0.85rem; color:#888; margin-bottom:10px;">¬øMe equivoqu√©? Marca la realidad y ens√©√±ame:</p>
        <div class="checkbox-group">
            <label><input type="checkbox" value="avion"> ‚úàÔ∏è Avi√≥n</label>
            <label><input type="checkbox" value="auto"> üöó Auto</label>
            <label><input type="checkbox" value="barco"> ‚õµ Barco</label>
        </div>
        <button class="teach-btn" onclick="ense√±arModelo()">üéì Re-entrenar Modelo</button>
        <div id="teach-msg" style="margin-top:15px; font-size:0.85rem; font-weight: bold; min-height: 20px;"></div>
    </div>
</div>

<script>
    let currentFile = null;

    async function procesarImagen() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length > 0) currentFile = fileInput.files[0];
        else if (!currentFile) return;

        const preview = document.getElementById('preview');
        const container = document.getElementById('resultados-container');
        const veredicto = document.getElementById('veredicto');
        const teachSec = document.getElementById('teach-section');
        const loader = document.getElementById('loader');

        if (fileInput.files.length > 0) {
            preview.style.display = 'block';
            preview.src = URL.createObjectURL(currentFile);
        }
        
        container.innerHTML = "";
        veredicto.style.display = "none";
        loader.style.display = 'block';
        if (!teachSec.style.display || teachSec.style.display === 'none') teachSec.style.display = 'none';

        const formData = new FormData();
        formData.append('file', currentFile);

        try {
            const response = await fetch('/predict', { method: 'POST', body: formData });
            const data = await response.json();
            
            loader.style.display = 'none';
            container.style.display = 'block';
            teachSec.style.display = 'block';

            let html = "";
            const sorted = Object.keys(data.confianza).sort((a,b) => data.confianza[b] - data.confianza[a]);
            
            // --- L√≥gica del Veredicto MULTILABEL ---
            let detectados = [];
            
            // Revisamos TODAS las clases para ver cu√°les superan el 90%
            for (const clase of sorted) {
                const prob = data.confianza[clase];
                if (prob > 0.90) {
                    let icono = "";
                    if(clase.includes("avion")) icono = "‚úàÔ∏è";
                    if(clase.includes("auto")) icono = "üöó";
                    if(clase.includes("barco")) icono = "‚õµ";
                    detectados.push(`${icono} ${clase.toUpperCase()}`);
                }
            }

            veredicto.style.display = "block";
            if (detectados.length > 0) {
                // Si hay 1, 2 o 3 detectados, los unimos con " + "
                veredicto.className = "veredicto-exito";
                veredicto.innerHTML = `¬°DETECTADO: <br> ${detectados.join(" + ")}!`;
            } else {
                veredicto.className = "veredicto-duda";
                veredicto.innerHTML = "ü§î An√°lisis incierto (Duda)";
            }
            // ---------------------------------------

            // Generar barras (esto sigue igual)
            for (const cls of sorted) {
                const pct = (data.confianza[cls] * 100).toFixed(1);
                let color = 'low';
                if(pct > 40) color = 'mid';
                if(pct > 70) color = 'high';
                
                html += `
                    <div class="result-item">
                        <div class="label-row"><span>${cls.toUpperCase()}</span><span>${pct}%</span></div>
                        <div class="progress-bg"><div class="progress-fill ${color}" style="width:${pct}%"></div></div>
                    </div>`;
            }
            container.innerHTML = html;

        } catch (e) {
            console.error(e);
            loader.innerText = "Error de conexi√≥n üîå";
        }
    }

    async function ense√±arModelo() {
        if (!currentFile) return;
        const msg = document.getElementById('teach-msg');
        const checked = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(c => c.value);
        
        if (checked.length === 0) {
            msg.innerText = "‚ö†Ô∏è Selecciona al menos una casilla.";
            msg.style.color = "#e67e22"; return;
        }

        msg.style.color = "#9b59b6";
        msg.innerText = "Aprendiendo... esto tomar√° unos segundos ‚è≥";

        const formData = new FormData();
        formData.append('file', currentFile);
        formData.append('etiquetas', checked.join(' '));

        try {
            const response = await fetch('/teach', { method: 'POST', body: formData });
            const data = await response.json();
            
            if(data.status === "ok") {
                msg.innerText = "¬°Listo! Verificando mejora... üîÑ";
                msg.style.color = "green";
                setTimeout(() => { procesarImagen(); msg.innerText = data.message; }, 1500);
            } else {
                msg.innerText = "Error: " + data.message;
                msg.style.color = "red";
            }
        } catch (e) {
            msg.innerText = "Error de red."; msg.style.color = "red";
        }
    }
</script>
</body>
</html>